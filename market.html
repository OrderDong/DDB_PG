<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta HTTP-EQUIV="pragma" CONTENT="no-cache">
	<meta HTTP-EQUIV="Cache-Control" CONTENT="no-store, must-revalidate">
	<meta HTTP-EQUIV="expires" CONTENT="Wed, 26 Feb 1997 08:21:57 GMT">
	<meta HTTP-EQUIV="expires" CONTENT="0">
    <title>蛋蛋的世界-蛋蛋市场</title>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./css/dd.css">
    <script language="javascript" type="text/javascript" src="js/EggAuctionWar_abi.js"></script>
    <script language="javascript" type="text/javascript" src="js/EggCard_abi.js"></script>
    <script language="javascript" type="text/javascript" src="js/EggCardAuction_abi.js"></script>
    <script language="javascript" type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body class="">
<div class="dandan_app">
    <!--头部-->
    <div class="layui-header">
        <ul class="layui-nav">
            <li class="layui-nav-item" lay-unselect="">
                <a href="javascript:;"><img src="http://t.cn/RCzsdCq" class="dd-nav-img">蛋蛋的世界</a>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="market.html">
                    市场
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="battle.html">
                    战争
                </a>
            </li>
            <li class="layui-nav-item">
                <a href="mydd.html">
                    我的
                </a>
            </li>
        </ul>
    </div>

    <!--主体-->
    <div class="layui-container">
        <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
            <ul class="layui-tab-title">
                <li class="layui-this">蛋蛋の市场</li>
                <li>买卖记录</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="market-ddfl">
                        <button class="layui-btn layui-btn-radius layui-btn-primary layui-btn-sm">白银蛋蛋</button>
                        <button class="layui-btn layui-btn-radius layui-btn-primary layui-btn-sm">黄金蛋蛋</button>
                        <button class="layui-btn layui-btn-radius layui-btn-primary layui-btn-sm" onclick="changeCard();">宝贝</button>
                    </div>
                    <div id="salesContent">
                        <!--<div class="market-dd-box">
                            <div class="market-dd-user">
                                <img src="http://t.cn/RCzsdCq" class="market-dd-img">
                                <p class="market-dd-name">superna</p>
                            </div>
                            <div class="market-dd-baby">
                                <div class="market-baby-img"><img src="http://t.cn/RCzsdCq"></div>
                                <p class="">宝贝名称</p>
                                <p class="">价格：0.03ETH × 3 个</p>
                                <button onclick="buyDD()" class="layui-btn layui-btn-radius layui-btn-normal layui-btn-xs">买入</button>
                            </div>
                        </div>-->
                    </div>
                </div>
                <div class="layui-tab-item" id="salesRecord">
                    <!--<dl class="record-nav">
                        <dt class="record-nav1">
                            <div class="record-nav-item1">
                                2颗白银蛋蛋
                            </div>
                            <div class="record-nav-item2">
                                卖出
                            </div>
                        </dt>
                        <dt class="record-nav2">
                            <div class="record-nav-item1">
                                0.024 ETH 每颗
                            </div>
                            <div class="record-nav-item2">
                                2018-05-02 19:21:00
                            </div>
                        </dt>
                    </dl>-->
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./layui/layui.js"></script>
<script>
    layui.use(['layer', 'form', 'element'], function () {
        var layer = layui.layer,
            element = layui.element,
            form = layui.form;
    });
</script>
<script language="javascript" type="text/javascript" src="js/common.js"></script>
<script>
    var actionInstance = initContractAuction(SalesAndPlayABI);
    var eggAuctionInstance = initContractCardAuction(eggCardAuction);
    var eggCardInstance = initContractEggCard(EggCardABI);
    
    var account = web3.eth.defaultAccount;
    var userName = localStorage.getItem("userName");
	//var eggCardInstance = initContractEggCard(EggCardABI);
	/*eggCardInstance.approve.sendTransaction("0x7A1b2716c3bbb411877CC782fA4Bfdf80538589c", "0",{from:account}, function (err, res) {
	    console.log(res);
	});*/
	
    /*var myEvent = actionInstance.AuctionSuccessful({winner: account}, {fromBlock: 0, toBlock: 'latest'});
    myEvent.watch(function(error, result){
        var args = result.args;
        var eType = args.eType.toString();
        var salesCount = args.salesCount.toString();
        var eTypeName;
        if (eType == 0) {
            eTypeName = " 颗白银蛋蛋";
        }
        var totalPrice = web3.fromWei(parseInt(args.totalPrice.toString())/parseInt(salesCount), 'ether');

        var time = (new Date(parseInt(args.time)*1000)).Format("yyyy-MM-dd hh:mm:ss");

        $("#salesRecord").append('' +
            '    <dl class="record-nav">\n' +
            '        <dt class="record-nav1">\n' +
            '        <div class="record-nav-item1">\n' + salesCount + eTypeName + '</div>\n' +
            '    <div class="record-nav-item2">\n' +
            '        买入\n' +
            '        </div>\n' +
            '        </dt>\n' +
            '        <dt class="record-nav2">\n' +
            '        <div class="record-nav-item1">\n' + totalPrice +
            '         ETH 每颗\n' +
            '    </div>\n' +
            '    <div class="record-nav-item2">\n' + time +
            '    </div>\n' +
            '    </dt>\n' +
            '    </dl>');

    });*/

    function getAuctionList() {
        console.log(actionInstance);
        actionInstance.getAuctions(function (error, result) {
            if (result.length > 0) {
            	console.log(result.length);
                for (i = 0; i < result.length; i++) {
                    actionInstance.getAuction(result[i], function (error, res) {
                    	console.log(res);
                        var id = parseInt(res[0].toString());
                        var seller = res[1].toString();
                        var sellerName = res[2].toString();
                        var price = res[3].toString();
                        var expiresAt = res[4].toString();
                        var salesCount = res[5].toString();
                        var value = web3.fromWei(price, 'ether');
                        var name = "蛋蛋币"
                        $("#salesContent").append('<div class="market-dd-box"><div class="market-dd-user">' +
                            '<img src="img/photo.png" class="market-dd-img"><p class="market-dd-name">' + sellerName + '</p></div>' +
                            '<div class="market-dd-baby"><div class="market-baby-img"><img src="img/dandan.png"></div>' +
                            '<p class="">' + name + '</p><p class="">价格：' + value + 'eth × ' + salesCount + ' 个</p>' +
                            '<input type="hidden" name="_auctionId" value="' + id + '" />' +
                            '<input type="hidden" name="_count" value="' + salesCount + '" />' +
                            '<input type="hidden" name="_price" value="' + value + '" />' +
                            '<button onclick="buyDD(this)" class="layui-btn layui-btn-radius layui-btn-normal layui-btn-xs">买入</button></div></div>');
                    });
                }
            }
        });
    }

  	getAuctionList();

    function buyDD(obj) {
        var _auctionId = $(obj).parent().find("input[name='_auctionId']").val();
        var _count = $(obj).parent().find("input[name='_count']").val();
        var _price = $(obj).parent().find("input[name='_price']").val();
        layer.open({
            title: '买入宝贝',
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            closeBtn: 1, //不显示关闭按钮
            anim: 2,
            area: ['315px', '240px'],
            shadeClose: true, //开启遮罩关闭
            content: '<div class="market-modal">' +
            '<div class="market-modal-img"><img src="http://t.cn/RCzsdCq"></div>' +
            '  <div class="market-modal-p"><p>价格：' + _price + 'ETH</p>' +
            '    <p>数量：' + _count + '个</p>' +
            '    <p>总价：' + _price * _count + 'ETH</p>' +
            '  </div></div>' +
            '<div class="market-modal-submit"><label class="layui-form-label1">买入数量：</label>' +
            '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-radius">-</button>' +
            '<input type="text" name="title" class="layui-input1" id="buyCount">' +
            '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-radius">+</button>' +
            '<button class="layui-btn layui-btn-sm layui-btn-normal layui-btn-radius" onclick="buyEx(' + _auctionId + ',' + _count + ',' + _price + ')">买入</button></div>'
        });
    }

    function buyEx(_auctionId, _count, _price) {
        var byCount = $("#buyCount").val();
        if (byCount <= 0 || byCount > _count) {
            alert("数量不正确！");
        }
        console.log(_auctionId + "," + byCount);
        actionInstance.executeEggAuction.sendTransaction(_auctionId, byCount, {
            from: web3.eth.defaultAccount,
            value: web3.toWei(_price*byCount)
        }, function (error, result) {

        });
//        actionInstance.events.AuctionSuccessful().on("data", function (event) {
//            var zombie = event.returnValues;
//            console.log("购买成功！", zombie._auctionId, zombie.price, zombie._count);
//        }).on('error', console.error);
    }
    //卡牌列表
	function changeCard(){
		//eggCardInstance
		eggAuctionInstance.getAuctionIndex(function (error, result) {
            if (result[0].c[0] > 0) {
                for (i = 0; i < result[1].length; i++) {
                	var tokenId = result[1][i].c[0];
                	var seller;
                	var price;
                	var expiresAt;
                	var eType;
                	var attrId;
                	var name ="";
                	var time;
                	
                    eggCardInstance.getCard(tokenId,function (error, res) {
                        eType = parseInt(res[5].toString());
                        attrId = parseInt(res[6].toString());
                        if (eType == 0) {
                            name = "金牛座";
                        }
                        console.log("curName:"+name);
                    });
                    eggAuctionInstance.getCardAuction(tokenId,function (error, res) {
                        seller = res[1].toString();
                       	price = res[2].toString();
                       	time = res[4].toString();
                       	console.log("eType:"+eType+",attrId:"+attrId+",name:"+name);
	                    var value = web3.fromWei(price, 'ether');
	                    $("#salesContent").append('<div class="market-dd-box"><div class="market-dd-user">' +
	                        '<img src="img/photo.png" class="market-dd-img"><p class="market-dd-name">' + userName + '</p></div>' +
	                        '<div class="market-dd-baby"><div class="market-baby-img"><img src="img/jinniu.png"></div>' +
	                        '<p class="">' + name + '</p><p class="">价格：' + value + ' DDC × 1 个</p>' +
	                        '<input type="hidden" name="_tokenId" value="' + tokenId + '" />' +
	                        '<input type="hidden" name="_price" value="' + price + '" />' +
	                        '<button onclick="buyCard(this)" class="layui-btn layui-btn-radius layui-btn-normal layui-btn-xs">买入</button></div></div>');
                    });
                   

                }
            }
        });
	}
	
	function buyCard(obj) {
        var _tokenId = $(obj).parent().find("input[name='_tokenId']").val();
        var _price = $(obj).parent().find("input[name='_price']").val();
        var value = web3.fromWei(_price, 'ether');
        layer.open({
            title: '买入宝贝',
            type: 1,
            skin: 'layui-layer-demo', //样式类名
            closeBtn: 1, //不显示关闭按钮
            anim: 2,
            area: ['315px', '240px'],
            shadeClose: true, //开启遮罩关闭
            content: '<div class="market-modal">' +
            '<div class="market-modal-img"><img src="img/jinniu1.png"></div>' +
            '  <div class="market-modal-p"><p>价格：' + value + ' DDC</p>' +
            '    <p>数量：1 个</p>' +
            '    <p>总价：' + value + ' DDC</p>' +
            '  </div></div>' +
            '<div class="market-modal-submit"><label class="layui-form-label1">买入数量：</label>' +
            '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-radius">-</button>' +
            '<input type="text" readonly name="title" class="layui-input1" id="buyCount" value="1">' +
            '<button class="layui-btn layui-btn-sm layui-btn-primary layui-btn-radius">+</button>' +
            '<button class="layui-btn layui-btn-sm layui-btn-normal layui-btn-radius" onclick="buyCardEx(' + _tokenId + ',' + _price + ')">买入</button></div>'
        });
    }
	
	function buyCardEx(_tokenId,_price) {
        console.log(_tokenId + "," + _price);
        eggAuctionInstance.executeCardAuction.sendTransaction(_tokenId, _price, function (error, result) {
			if(error != null){
				console.log(error);
			}
			console.log(result);
        });
    }
	
</script>
</body>

</html>